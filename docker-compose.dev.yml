# Docker Compose for Dokploy Development Deployment
# Domain: dev.finio.cloud
# API: api-dev.finio.cloud
#
# This file is for the DEVELOPMENT environment.
# Uses images tagged with :dev from GHCR.
# More verbose logging, relaxed resource limits.

services:
  # ==================== BACKEND SERVICES ====================

  # Auth Service (Authentication & Authorization)
  auth-service:
    image: ghcr.io/${GITHUB_REPOSITORY:-timkrebs/qnt9-srs}/auth-service:${IMAGE_TAG:-dev}
    pull_policy: always
    container_name: finio-dev-auth-service
    environment:
      DATABASE_URL: ${DATABASE_URL}
      DATABASE_POOL_SIZE: 5
      DATABASE_POOL_MIN_SIZE: 1
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 60
      REFRESH_TOKEN_EXPIRE_DAYS: 30
      PASSWORD_HASH_ROUNDS: 10
      APP_NAME: finio Auth Service (Dev)
      DEBUG: "true"
      LOG_LEVEL: DEBUG
      CORS_ORIGINS: https://dev.finio.cloud,https://api-dev.finio.cloud,http://localhost:3000,http://localhost:8010
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_KEY: ${SUPABASE_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dev-auth-service.rule=Host(`api-dev.finio.cloud`) && (PathPrefix(`/api/v1/auth`) || PathPrefix(`/api/v1/users`))"
      - "traefik.http.routers.dev-auth-service.entrypoints=websecure"
      - "traefik.http.routers.dev-auth-service.tls.certResolver=letsencrypt"
      - "traefik.http.services.dev-auth-service.loadbalancer.server.port=8010"
      - "traefik.http.services.dev-auth-service.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.dev-auth-service.loadbalancer.healthcheck.interval=30s"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 64M

  # User Service
  user-service:
    image: ghcr.io/${GITHUB_REPOSITORY:-timkrebs/qnt9-srs}/user-service:${IMAGE_TAG:-dev}
    pull_policy: always
    container_name: finio-dev-user-service
    environment:
      SERVICE_NAME: user-service
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: 8011
      LOG_LEVEL: DEBUG
      DATABASE_URL: ${DATABASE_URL}
      DATABASE_POOL_SIZE: 5
      DATABASE_POOL_MIN_SIZE: 1
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}
      STRIPE_API_KEY: ${STRIPE_API_KEY:-sk_test_stub}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-whsec_stub}
      CORS_ORIGINS: https://dev.finio.cloud,https://api-dev.finio.cloud,http://localhost:3000
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dev-user-service.rule=Host(`api-dev.finio.cloud`) && (PathPrefix(`/api/v1/profile`) || PathPrefix(`/api/v1/subscription`))"
      - "traefik.http.routers.dev-user-service.entrypoints=websecure"
      - "traefik.http.routers.dev-user-service.tls.certResolver=letsencrypt"
      - "traefik.http.services.dev-user-service.loadbalancer.server.port=8011"
      - "traefik.http.services.dev-user-service.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.dev-user-service.loadbalancer.healthcheck.interval=30s"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 64M

  # Watchlist Service
  watchlist-service:
    image: ghcr.io/${GITHUB_REPOSITORY:-timkrebs/qnt9-srs}/watchlist-service:${IMAGE_TAG:-dev}
    pull_policy: always
    container_name: finio-dev-watchlist-service
    environment:
      SERVICE_NAME: watchlist-service
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: 8012
      LOG_LEVEL: DEBUG
      DEBUG: "true"
      DATABASE_URL: ${DATABASE_URL}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: HS256
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}
      FREE_TIER_WATCHLIST_LIMIT: 10
      PAID_TIER_WATCHLIST_LIMIT: 999
      CORS_ORIGINS: https://dev.finio.cloud,https://api-dev.finio.cloud,http://localhost:3000
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dev-watchlist-service.rule=Host(`api-dev.finio.cloud`) && PathPrefix(`/api/watchlist`)"
      - "traefik.http.routers.dev-watchlist-service.entrypoints=websecure"
      - "traefik.http.routers.dev-watchlist-service.tls.certResolver=letsencrypt"
      - "traefik.http.services.dev-watchlist-service.loadbalancer.server.port=8012"
      - "traefik.http.services.dev-watchlist-service.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.dev-watchlist-service.loadbalancer.healthcheck.interval=30s"
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8012/health', timeout=5.0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 64M

  # Search Service
  search-service:
    image: ghcr.io/${GITHUB_REPOSITORY:-timkrebs/qnt9-srs}/search-service:${IMAGE_TAG:-dev}
    pull_policy: always
    container_name: finio-dev-search-service
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL:-}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      AUTH_SERVICE_URL: http://auth-service:8010
      CORS_ALLOWED_ORIGINS: https://dev.finio.cloud,https://api-dev.finio.cloud,http://localhost:3000
      YAHOO_FINANCE_TIMEOUT: 10.0
      YAHOO_FINANCE_MAX_RETRIES: 5
      YAHOO_FINANCE_RATE_LIMIT: 10
      MASSIVE_API_KEY: ${MASSIVE_API_KEY:-}
      MASSIVE_USE_REALTIME: ${MASSIVE_USE_REALTIME:-false}
      POSTGRES_CACHE_TTL_MINUTES: 1
      CIRCUIT_BREAKER_FAILURE_THRESHOLD: 10
      CIRCUIT_BREAKER_RECOVERY_TIMEOUT: 30
      LOG_LEVEL: DEBUG
      LOG_FORMAT: text
      PROMETHEUS_ENABLED: true
      METRICS_PORT: 9090
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dev-search-service.rule=Host(`api-dev.finio.cloud`) && (PathPrefix(`/api/v1/search`) || PathPrefix(`/api/v1/stocks`) || PathPrefix(`/api/v1/health`) || PathPrefix(`/api/v1/tickers`) || PathPrefix(`/api/v1/autocomplete`) || PathPrefix(`/api/v1/chart`))"
      - "traefik.http.routers.dev-search-service.entrypoints=websecure"
      - "traefik.http.routers.dev-search-service.tls.certResolver=letsencrypt"
      - "traefik.http.services.dev-search-service.loadbalancer.server.port=8000"
      - "traefik.http.services.dev-search-service.loadbalancer.healthcheck.path=/api/v1/health"
      - "traefik.http.services.dev-search-service.loadbalancer.healthcheck.interval=30s"
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/api/v1/health', timeout=5.0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # Notification Service
  notification-service:
    image: ghcr.io/${GITHUB_REPOSITORY:-timkrebs/qnt9-srs}/notification-service:${IMAGE_TAG:-dev}
    pull_policy: always
    container_name: finio-dev-notification-service
    environment:
      SERVICE_NAME: notification-service
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: 8040
      LOG_LEVEL: INFO
      DATABASE_URL: ${DATABASE_URL}
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}
      RESEND_API_KEY: ${RESEND_API_KEY}
      RESEND_FROM_EMAIL: noreply@qnt9.com
      RESEND_FROM_NAME: QNT9 Stock Research
      SEARCH_SERVICE_URL: http://search-service:8000
      NOTIFICATION_CHECK_INTERVAL: 3600
      PRICE_ALERT_SEND_HOUR: 8
      ALERT_COOLDOWN_HOURS: 24
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dev-notification-service.rule=Host(`api-dev.finio.cloud`) && PathPrefix(`/api/v1/preferences`,`/api/v1/admin`)"
      - "traefik.http.routers.dev-notification-service.entrypoints=websecure"
      - "traefik.http.routers.dev-notification-service.tls.certResolver=letsencrypt"
      - "traefik.http.services.dev-notification-service.loadbalancer.server.port=8040"
      - "traefik.http.services.dev-notification-service.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.dev-notification-service.loadbalancer.healthcheck.interval=30s"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8040/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 64M

  # ==================== FRONTEND ====================

  # Webapp Service (Next.js)
  webapp-service:
    image: ghcr.io/${GITHUB_REPOSITORY:-timkrebs/qnt9-srs}/webapp-service:${IMAGE_TAG:-dev}
    pull_policy: always
    container_name: finio-dev-webapp-service
    environment:
      NEXT_PUBLIC_AUTH_SERVICE_URL: https://api-dev.finio.cloud
      NEXT_PUBLIC_SEARCH_SERVICE_URL: https://api-dev.finio.cloud
      NEXT_PUBLIC_WATCHLIST_SERVICE_URL: https://api-dev.finio.cloud
      NEXT_PUBLIC_USER_SERVICE_URL: https://api-dev.finio.cloud
      NEXT_PUBLIC_NOTIFICATION_SERVICE_URL: https://api-dev.finio.cloud
      NEXT_PUBLIC_SUPABASE_URL: ${SUPABASE_URL}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${SUPABASE_KEY}
      NODE_ENV: development
      PORT: 3000
      HOSTNAME: 0.0.0.0
      NEXT_TELEMETRY_DISABLED: 1
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.finio-dev-webapp.rule=Host(`dev.finio.cloud`)"
      - "traefik.http.routers.finio-dev-webapp.entrypoints=websecure"
      - "traefik.http.routers.finio-dev-webapp.tls.certResolver=letsencrypt"
      - "traefik.http.routers.finio-dev-webapp.service=finio-dev-webapp"
      - "traefik.http.services.finio-dev-webapp.loadbalancer.server.port=3000"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 64M

networks:
  dokploy-network:
    external: true
