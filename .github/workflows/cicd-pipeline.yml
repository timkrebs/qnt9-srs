# QNT9-SRS CI/CD Pipeline
# Implements: Infrastructure -> Source -> Build -> Test -> Release -> Cleanup
# Infrastructure is provisioned on-demand via Terraform and destroyed after non-prod runs
# Environments: dev (development/feature branches), staging, prd (main)

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - development
      - staging
      - 'feature/**'
      - 'release/**'
    paths:
      - 'services/**'
      - 'infrastructure/**'
      - '.github/workflows/cicd-pipeline.yml'
  pull_request:
    branches:
      - main
      - development
      - staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for deployment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prd
      skip_destroy:
        description: 'Skip infrastructure destruction (keep resources)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  COVERAGE_THRESHOLD: 80

jobs:
  # ==========================================================================
  # INFRASTRUCTURE STAGE - Provision AKS/ACR via Terraform
  # ==========================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      auth-service: ${{ steps.filter.outputs.auth-service }}
      search-service: ${{ steps.filter.outputs.search-service }}
      frontend-service: ${{ steps.filter.outputs.frontend-service }}
      user-service: ${{ steps.filter.outputs.user-service }}
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
      any-service: ${{ steps.filter.outputs.any-service }}
      environment: ${{ steps.set-env.outputs.environment }}
      run_id: ${{ steps.set-env.outputs.run_id }}
      is_ephemeral: ${{ steps.set-env.outputs.is_ephemeral }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Filter paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            auth-service:
              - 'services/auth-service/**'
            search-service:
              - 'services/search-service/**'
            frontend-service:
              - 'services/frontend-service/**'
            user-service:
              - 'services/user-service/**'
            infrastructure:
              - 'infrastructure/**'
            any-service:
              - 'services/**'

      - name: Set environment and run configuration
        id: set-env
        run: |
          # Determine environment
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="prd"
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            ENV="staging"
          else
            ENV="dev"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          
          # Generate unique run ID for ephemeral deployments
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            RUN_ID="pr${{ github.event.pull_request.number }}"
          else
            RUN_ID="run${{ github.run_number }}"
          fi
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          
          # Production is never ephemeral
          if [[ "$ENV" == "prd" ]]; then
            echo "is_ephemeral=false" >> $GITHUB_OUTPUT
          else
            echo "is_ephemeral=true" >> $GITHUB_OUTPUT
          fi
          
          echo "Environment: $ENV, Run ID: $RUN_ID"

  provision-infrastructure:
    name: Provision Infrastructure
    runs-on: ubuntu-latest
    needs: detect-changes
    outputs:
      acr_login_server: ${{ steps.terraform.outputs.acr_login_server }}
      acr_admin_username: ${{ steps.terraform.outputs.acr_admin_username }}
      acr_admin_password: ${{ steps.terraform.outputs.acr_admin_password }}
      aks_cluster_name: ${{ steps.terraform.outputs.aks_cluster_name }}
      resource_group_name: ${{ steps.terraform.outputs.resource_group_name }}
    env:
      # Azure Provider credentials
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      # Terraform Cloud credentials
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0
          terraform_wrapper: false
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Determine Workspace
        id: workspace
        run: |
          ENV="${{ needs.detect-changes.outputs.environment }}"
          RUN_ID="${{ needs.detect-changes.outputs.run_id }}"
          IS_EPHEMERAL="${{ needs.detect-changes.outputs.is_ephemeral }}"
          
          # Workspace naming: qnt9-srs-{env} or qnt9-srs-{env}-{run_id} for ephemeral
          if [[ "$IS_EPHEMERAL" == "true" ]]; then
            WORKSPACE="qnt9-srs-${ENV}-${RUN_ID}"
          else
            WORKSPACE="qnt9-srs-${ENV}"
          fi
          
          echo "workspace=$WORKSPACE" >> $GITHUB_OUTPUT
          echo "Using Terraform Cloud workspace: $WORKSPACE"

      - name: Create Terraform Variables
        working-directory: infrastructure/terraform
        run: |
          cat > cicd.auto.tfvars <<EOF
          environment = "${{ needs.detect-changes.outputs.environment }}"
          ephemeral   = ${{ needs.detect-changes.outputs.is_ephemeral }}
          run_id      = "${{ needs.detect-changes.outputs.run_id }}"
          enable_icinga       = ${{ needs.detect-changes.outputs.is_ephemeral == 'true' && 'false' || 'true' }}
          enable_function_app = ${{ needs.detect-changes.outputs.is_ephemeral == 'true' && 'false' || 'true' }}
          location = "germanywestcentral"
          cost_center          = "QNT9-CICD"
          owner_email          = "cicd@qnt9.io"
          business_owner_email = "devops@qnt9.io"
          budget_code          = "CICD-${{ needs.detect-changes.outputs.environment }}"
          data_classification  = "Internal"
          criticality          = "${{ needs.detect-changes.outputs.environment == 'prd' && 'Critical' || 'Low' }}"
          compliance_requirements = "GDPR"
          data_residency       = "Germany"
          aks_node_count           = ${{ needs.detect-changes.outputs.environment == 'prd' && '3' || '2' }}
          aks_vm_size              = "${{ needs.detect-changes.outputs.environment == 'prd' && 'Standard_D2s_v3' || 'Standard_B2s' }}"
          aks_ephemeral_node_count = 1
          aks_ephemeral_vm_size    = "Standard_B2s"
          aks_kubernetes_version   = "1.31.11"
          EOF

      - name: Terraform Init
        working-directory: infrastructure/terraform
        env:
          TF_WORKSPACE: ${{ steps.workspace.outputs.workspace }}
        run: |
          echo "Initializing Terraform with HCP Terraform Cloud..."
          terraform init -input=false

      - name: Terraform Plan
        working-directory: infrastructure/terraform
        env:
          TF_WORKSPACE: ${{ steps.workspace.outputs.workspace }}
        run: |
          terraform plan -input=false -out=tfplan

      - name: Terraform Apply
        working-directory: infrastructure/terraform
        env:
          TF_WORKSPACE: ${{ steps.workspace.outputs.workspace }}
        run: |
          terraform apply -auto-approve -input=false tfplan

      - name: Get Terraform Outputs
        id: terraform
        working-directory: infrastructure/terraform
        run: |
          ACR_LOGIN_SERVER=$(terraform output -raw acr_login_server 2>/dev/null || echo "")
          ACR_ADMIN_USERNAME=$(terraform output -raw acr_admin_username 2>/dev/null || echo "")
          ACR_ADMIN_PASSWORD=$(terraform output -raw acr_admin_password 2>/dev/null || echo "")
          AKS_CLUSTER_NAME=$(terraform output -raw aks_cluster_name 2>/dev/null || echo "")
          RESOURCE_GROUP=$(terraform output -raw resource_group_name 2>/dev/null || echo "")
          
          echo "acr_login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
          echo "acr_admin_username=$ACR_ADMIN_USERNAME" >> $GITHUB_OUTPUT
          echo "::add-mask::$ACR_ADMIN_PASSWORD"
          echo "acr_admin_password=$ACR_ADMIN_PASSWORD" >> $GITHUB_OUTPUT
          echo "aks_cluster_name=$AKS_CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "resource_group_name=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
          
          echo "ACR: $ACR_LOGIN_SERVER | AKS: $AKS_CLUSTER_NAME"

  # ==========================================================================
  # SOURCE STAGE
  # ==========================================================================
  lint:
    name: Lint and Security Scan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any-service == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install black isort ruff bandit
      - run: black --check --diff services/ || true
      - run: isort --check-only --diff services/ || true
      - run: ruff check services/ || true
      - run: bandit -r services/ -ll -ii --exclude '**/tests/**' || true

  # ==========================================================================
  # BUILD STAGE
  # ==========================================================================
  build-auth-service:
    name: Build Auth Service
    runs-on: ubuntu-latest
    needs: [detect-changes, provision-infrastructure, lint]
    if: |
      always() &&
      (needs.detect-changes.outputs.auth-service == 'true' || github.ref == 'refs/heads/main') &&
      needs.provision-infrastructure.result == 'success' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped')
    env:
      REGISTRY: ${{ needs.provision-infrastructure.outputs.acr_login_server }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: services/auth-service/requirements.txt
      - name: Install and test
        working-directory: services/auth-service
        run: |
          pip install -r requirements.txt pytest pytest-cov pytest-asyncio
          pytest tests/ -v --cov=app --cov-report=xml --cov-fail-under=${{ env.COVERAGE_THRESHOLD }}
        env:
          JWT_SECRET_KEY: test-secret-key-for-testing-only-32chars
          JWT_ALGORITHM: HS256
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          PASSWORD_HASH_ROUNDS: 4
      - uses: codecov/codecov-action@v4
        with:
          files: services/auth-service/coverage.xml
          flags: auth-service
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ needs.provision-infrastructure.outputs.acr_admin_username }}
          password: ${{ needs.provision-infrastructure.outputs.acr_admin_password }}
      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/qnt9-auth-service
          tags: |
            type=raw,value=${{ needs.detect-changes.outputs.environment }}-${{ github.sha }}
            type=raw,value=${{ needs.detect-changes.outputs.environment }}-latest
      - uses: docker/build-push-action@v5
        with:
          context: services/auth-service
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-search-service:
    name: Build Search Service
    runs-on: ubuntu-latest
    needs: [detect-changes, provision-infrastructure, lint]
    if: |
      always() &&
      (needs.detect-changes.outputs.search-service == 'true' || github.ref == 'refs/heads/main') &&
      needs.provision-infrastructure.result == 'success' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped')
    env:
      REGISTRY: ${{ needs.provision-infrastructure.outputs.acr_login_server }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: services/search-service/requirements.txt
      - name: Install and test
        working-directory: services/search-service
        run: |
          pip install -r requirements.txt pytest pytest-cov pytest-asyncio
          pytest tests/ -v --cov=app --cov-report=xml --cov-fail-under=70
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          JWT_SECRET_KEY: test-secret-key
      - uses: codecov/codecov-action@v4
        with:
          files: services/search-service/coverage.xml
          flags: search-service
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ needs.provision-infrastructure.outputs.acr_admin_username }}
          password: ${{ needs.provision-infrastructure.outputs.acr_admin_password }}
      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/qnt9-search-service
          tags: |
            type=raw,value=${{ needs.detect-changes.outputs.environment }}-${{ github.sha }}
            type=raw,value=${{ needs.detect-changes.outputs.environment }}-latest
      - uses: docker/build-push-action@v5
        with:
          context: services/search-service
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend-service:
    name: Build Frontend Service
    runs-on: ubuntu-latest
    needs: [detect-changes, provision-infrastructure, lint]
    if: |
      always() &&
      (needs.detect-changes.outputs.frontend-service == 'true' || github.ref == 'refs/heads/main') &&
      needs.provision-infrastructure.result == 'success' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped')
    env:
      REGISTRY: ${{ needs.provision-infrastructure.outputs.acr_login_server }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: services/frontend-service/requirements.txt
      - name: Install and test
        working-directory: services/frontend-service
        run: |
          pip install -r requirements.txt pytest pytest-cov pytest-asyncio
          pytest tests/ -v --cov=app --cov-report=xml --cov-fail-under=70 || true
      - uses: codecov/codecov-action@v4
        with:
          files: services/frontend-service/coverage.xml
          flags: frontend-service
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ needs.provision-infrastructure.outputs.acr_admin_username }}
          password: ${{ needs.provision-infrastructure.outputs.acr_admin_password }}
      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/qnt9-frontend-service
          tags: |
            type=raw,value=${{ needs.detect-changes.outputs.environment }}-${{ github.sha }}
            type=raw,value=${{ needs.detect-changes.outputs.environment }}-latest
      - uses: docker/build-push-action@v5
        with:
          context: services/frontend-service
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-user-service:
    name: Build User Service
    runs-on: ubuntu-latest
    needs: [detect-changes, provision-infrastructure, lint]
    if: |
      always() &&
      (needs.detect-changes.outputs.user-service == 'true' || github.ref == 'refs/heads/main') &&
      needs.provision-infrastructure.result == 'success' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped')
    env:
      REGISTRY: ${{ needs.provision-infrastructure.outputs.acr_login_server }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ needs.provision-infrastructure.outputs.acr_admin_username }}
          password: ${{ needs.provision-infrastructure.outputs.acr_admin_password }}
      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/qnt9-user-service
          tags: |
            type=raw,value=${{ needs.detect-changes.outputs.environment }}-${{ github.sha }}
            type=raw,value=${{ needs.detect-changes.outputs.environment }}-latest
      - uses: docker/build-push-action@v5
        with:
          context: services/user-service
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================================================
  # TEST STAGE
  # ==========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, provision-infrastructure, build-auth-service, build-search-service, build-frontend-service]
    if: |
      always() &&
      needs.detect-changes.outputs.any-service == 'true' &&
      needs.provision-infrastructure.result == 'success'
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: qnt9
          POSTGRES_PASSWORD: qnt9password
          POSTGRES_DB: qnt9_db
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - run: PGPASSWORD=qnt9password psql -h localhost -U qnt9 -d qnt9_db -f infrastructure/postgres/init.sql
      - name: Run tests
        working-directory: tests/integration
        run: |
          pip install -r requirements.txt
          pytest -v --tb=short || true
        env:
          DATABASE_URL: postgresql://qnt9:qnt9password@localhost:5432/qnt9_db
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET_KEY: test-secret-key

  # ==========================================================================
  # RELEASE STAGE
  # ==========================================================================
  deploy:
    name: Deploy to ${{ needs.detect-changes.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [detect-changes, provision-infrastructure, integration-tests]
    if: |
      always() &&
      needs.provision-infrastructure.result == 'success' &&
      needs.integration-tests.result == 'success'
    environment:
      name: ${{ needs.detect-changes.outputs.environment }}
    env:
      REGISTRY: ${{ needs.provision-infrastructure.outputs.acr_login_server }}
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ secrets.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.ARM_TENANT_ID }}"}'
      - uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ needs.provision-infrastructure.outputs.resource_group_name }}
          cluster-name: ${{ needs.provision-infrastructure.outputs.aks_cluster_name }}
      - name: Create namespace and secrets
        run: |
          kubectl create namespace qnt9 --dry-run=client -o yaml | kubectl apply -f -
          
          # Create Kubernetes secrets from GitHub secrets
          kubectl create secret generic qnt9-secrets -n qnt9 \
            --from-literal=database-url="${{ secrets.DATABASE_URL }}" \
            --from-literal=jwt-secret-key="${{ secrets.JWT_SECRET_KEY }}" \
            --from-literal=redis-url="${{ secrets.REDIS_URL }}" \
            --dry-run=client -o yaml | kubectl apply -f -
          
          # Create ACR pull secret
          kubectl create secret docker-registry acr-secret -n qnt9 \
            --docker-server="${{ env.REGISTRY }}" \
            --docker-username="${{ needs.provision-infrastructure.outputs.acr_admin_username }}" \
            --docker-password="${{ needs.provision-infrastructure.outputs.acr_admin_password }}" \
            --dry-run=client -o yaml | kubectl apply -f -
      - name: Deploy services
        run: |
          export IMAGE_TAG="${{ needs.detect-changes.outputs.environment }}-${{ github.sha }}"
          export ENVIRONMENT="${{ needs.detect-changes.outputs.environment }}"
          export ACR_LOGIN_SERVER="${{ env.REGISTRY }}"
          
          # Apply base resources in order
          kubectl apply -f infrastructure/kubernetes/base/namespace.yaml || true
          kubectl apply -f infrastructure/kubernetes/base/service-account.yaml || true
          kubectl apply -f infrastructure/kubernetes/base/network-policy.yaml || true
          kubectl apply -f infrastructure/kubernetes/base/ingress.yaml || true
          
          # Deploy each service
          for service in auth-service search-service frontend-service user-service; do
            if [ -d "infrastructure/kubernetes/$service" ]; then
              for manifest in infrastructure/kubernetes/$service/*.yaml; do
                envsubst < "$manifest" | kubectl apply -f - || true
              done
            fi
          done
      - name: Wait for rollouts
        run: |
          for svc in auth-service search-service frontend-service user-service; do
            kubectl rollout status deployment/$svc -n qnt9 --timeout=300s || true
          done
      - run: kubectl get pods -n qnt9 && kubectl get svc -n qnt9

  # ==========================================================================
  # CLEANUP STAGE - Destroy ephemeral infrastructure (non-prod only)
  # ==========================================================================
  destroy-infrastructure:
    name: Destroy Ephemeral Infrastructure
    runs-on: ubuntu-latest
    needs: [detect-changes, provision-infrastructure, deploy]
    if: |
      always() &&
      needs.detect-changes.outputs.is_ephemeral == 'true' &&
      needs.provision-infrastructure.result == 'success' &&
      github.event.inputs.skip_destroy != 'true'
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ secrets.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.ARM_TENANT_ID }}"}'

      - name: Get State Storage Account
        id: state-storage
        run: |
          STORAGE_ACCOUNT="qnt9tfstate$(echo ${{ secrets.ARM_SUBSCRIPTION_ID }} | cut -c1-8)"
          echo "storage_account=$STORAGE_ACCOUNT" >> $GITHUB_OUTPUT

      - name: Destroy Infrastructure
        working-directory: infrastructure/terraform
        run: |
          ENV="${{ needs.detect-changes.outputs.environment }}"
          RUN_ID="${{ needs.detect-changes.outputs.run_id }}"
          STATE_KEY="${ENV}-${RUN_ID}.tfstate"
          
          # Create the same tfvars used during provisioning
          cat > cicd.auto.tfvars <<EOF
          environment = "${ENV}"
          ephemeral   = true
          run_id      = "${RUN_ID}"
          enable_icinga       = false
          enable_function_app = false
          location = "germanywestcentral"
          cost_center          = "QNT9-CICD"
          owner_email          = "cicd@qnt9.io"
          business_owner_email = "devops@qnt9.io"
          budget_code          = "CICD-${ENV}"
          data_classification  = "Internal"
          criticality          = "Low"
          compliance_requirements = "GDPR"
          data_residency       = "Germany"
          aks_node_count           = 2
          aks_vm_size              = "Standard_B2s"
          aks_ephemeral_node_count = 1
          aks_ephemeral_vm_size    = "Standard_B2s"
          aks_kubernetes_version   = "1.31.11"
          EOF
          
          # Initialize with the same backend config
          terraform init \
            -backend-config="resource_group_name=qnt9-terraform-state-rg" \
            -backend-config="storage_account_name=${{ steps.state-storage.outputs.storage_account }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=$STATE_KEY"
          
          # Destroy infrastructure
          terraform destroy -auto-approve -input=false
          
          echo "Infrastructure destroyed"

      - name: Delete State File
        if: always()
        run: |
          ENV="${{ needs.detect-changes.outputs.environment }}"
          RUN_ID="${{ needs.detect-changes.outputs.run_id }}"
          STATE_KEY="${ENV}-${RUN_ID}.tfstate"
          STORAGE_ACCOUNT="${{ steps.state-storage.outputs.storage_account }}"
          
          # Delete the ephemeral state file
          az storage blob delete \
            --account-name "$STORAGE_ACCOUNT" \
            --container-name tfstate \
            --name "$STATE_KEY" \
            --output none || true
          
          echo "State file $STATE_KEY deleted"

  # ==========================================================================
  # SUMMARY
  # ==========================================================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, provision-infrastructure, lint, build-auth-service, build-search-service, build-frontend-service, integration-tests, deploy, destroy-infrastructure]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## QNT9-SRS CI/CD Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.detect-changes.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ephemeral | ${{ needs.detect-changes.outputs.is_ephemeral }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | ${{ needs.detect-changes.outputs.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.provision-infrastructure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Auth Service | ${{ needs.build-auth-service.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Search Service | ${{ needs.build-search-service.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Service | ${{ needs.build-frontend-service.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cleanup | ${{ needs.destroy-infrastructure.result }} |" >> $GITHUB_STEP_SUMMARY
