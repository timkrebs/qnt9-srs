services:
  # ==================== MESSAGING ====================
  
  # Zookeeper for Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: qnt9-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - qnt9-network
    healthcheck:
      test: ["CMD", "echo", "ruok", "|", "nc", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka for Event Streaming
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: qnt9-kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_CREATE_TOPICS: "raw-stock-data:3:1,processed-stock-data:3:1,ml-features:3:1,raw-news:3:1,enriched-news:3:1"
    networks:
      - qnt9-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ==================== BACKEND SERVICES ====================
  
  # User Service (User Profile & Subscription Management)
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: qnt9-user-service
    environment:
      SERVICE_NAME: user-service
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: 8011
      LOG_LEVEL: INFO
      SUPABASE_DB_URL: ${SUPABASE_DB_URL}
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      STRIPE_API_KEY: ${STRIPE_API_KEY:-sk_test_stub}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-whsec_stub}
    ports:
      - "8011:8011"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - qnt9-network
    restart: unless-stopped

  # Auth Service (Authentication & Authorization)
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: qnt9-auth-service
    environment:
      # Supabase Configuration
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_DB_URL: ${SUPABASE_DB_URL}
      
      # JWT Configuration
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-secret-key-change-in-production}
      JWT_ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
      
      # Service Configuration
      APP_NAME: QNT9 Auth Service
      DEBUG: "true"
      LOG_LEVEL: DEBUG
      
      # CORS Configuration
      CORS_ORIGINS: http://localhost:8080,http://localhost:3000,http://frontend-service:8080
    ports:
      - "8010:8010"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - qnt9-network
    restart: unless-stopped

  # Search Service (Stock Search API)
  search-service:
    build:
      context: ./services/search-service
      dockerfile: Dockerfile.dev
    container_name: qnt9-search-service
    environment:
      # Database (Supabase)
      SUPABASE_DB_URL: ${SUPABASE_DB_URL}
      
      # Supabase Authentication (for user tier checking)
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      
      # CORS
      CORS_ORIGINS: http://localhost:8080,http://localhost:3000,http://frontend-service:8080
      
      # External APIs
      YAHOO_FINANCE_TIMEOUT: 5.0
      YAHOO_FINANCE_MAX_RETRIES: 3
      YAHOO_FINANCE_RATE_LIMIT: 5
      
      # Cache Settings (PostgreSQL only - Redis removed)
      POSTGRES_CACHE_TTL_MINUTES: 5
      
      # Circuit Breaker
      CIRCUIT_BREAKER_FAILURE_THRESHOLD: 5
      CIRCUIT_BREAKER_RECOVERY_TIMEOUT: 60
      
      # Logging
      LOG_LEVEL: DEBUG
      LOG_FORMAT: text
      
      # Monitoring
      PROMETHEUS_ENABLED: true
      METRICS_PORT: 9090
    ports:
      - "8000:8000"
      - "9090:9090"  # Prometheus metrics
    volumes:
      # Mount source code for hot-reload
      - ./services/search-service/app:/app/app:ro
      - ./services/search-service/alembic:/app/alembic:ro
      - ./services/search-service/alembic.ini:/app/alembic.ini:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - qnt9-network
    restart: unless-stopped

  # ==================== FRONTEND ====================
  
  # Frontend Service (Web UI)
  frontend-service:
    build:
      context: ./services/frontend-service
      dockerfile: Dockerfile.dev
    container_name: qnt9-frontend-service
    environment:
      # Service URLs
      SEARCH_SERVICE_URL: http://search-service:8000
      AUTH_SERVICE_URL: http://auth-service:8010
      USER_SERVICE_URL: http://user-service:8011
      
      # Supabase
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      
      # Service Configuration
      SERVICE_NAME: frontend-service
      HOST: 0.0.0.0
      PORT: 8080
      LOG_LEVEL: DEBUG
      DEBUG: "true"
      
      # CORS
      CORS_ORIGINS: http://localhost:8080,http://localhost:3000
    ports:
      - "8080:8080"
    volumes:
      - ./services/frontend-service/app:/app/app:ro
    depends_on:
      search-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - qnt9-network
    restart: unless-stopped

networks:
  qnt9-network:
    driver: bridge
