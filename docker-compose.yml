services:
  # ==================== DATABASE & CACHE ====================

  # ==================== MESSAGING ====================

  # Prefect Server (Orchestration UI & API)
  prefect-server:
    image: prefecthq/prefect:2-latest
    container_name: finio-prefect-server
    command: prefect server start
    ports:
      - "4200:4200"
    environment:
      # URL for the UI to access the API (transpiled to browser)
      PREFECT_UI_API_URL: http://localhost:4200/api
      # Bind to all interfaces
      PREFECT_SERVER_API_HOST: 0.0.0.0
    networks:
      - finio-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4200/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== BACKEND SERVICES ====================

  # User Service (User Profile & Subscription Management)
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: finio-user-service
    environment:
      SERVICE_NAME: user-service
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: 8011
      LOG_LEVEL: INFO
      DEBUG: "true"
      DATABASE_URL: ${DATABASE_URL}
      DATABASE_POOL_SIZE: 20
      DATABASE_POOL_MIN_SIZE: 5
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}
      STRIPE_API_KEY: ${STRIPE_API_KEY:-sk_test_stub}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-whsec_stub}
      CORS_ORIGINS: http://localhost:8080,http://localhost:3000
    ports:
      - "8011:8011"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8011/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - finio-network
    restart: unless-stopped

  # Auth Service (Authentication & Authorization)
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: finio-auth-service
    environment:
      # Database Configuration
      DATABASE_URL: ${DATABASE_URL}
      DATABASE_POOL_SIZE: 20
      DATABASE_POOL_MIN_SIZE: 5

      # JWT Configuration
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-super-secret-key-change-in-production-min-32-chars}
      JWT_ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
      REFRESH_TOKEN_EXPIRE_DAYS: 7

      # Password Hashing
      PASSWORD_HASH_ROUNDS: 12

      # Service Configuration
      APP_NAME: Finio Auth Service
      DEBUG: "true"
      LOG_LEVEL: DEBUG

      # CORS Configuration
      CORS_ORIGINS: http://localhost:8080,http://localhost:3000

      # Redis Configuration
      REDIS_URL: ${REDIS_URL}
      REDIS_MAX_CONNECTIONS: 50
      CACHE_PREFIX: "finio:auth:cache:"
      CACHE_DEFAULT_TTL: 300
      RATE_LIMIT_PREFIX: "finio:auth:ratelimit:"
      RATE_LIMIT_WINDOW_SECONDS: 60
      RATE_LIMIT_MAX_REQUESTS: 60

      # Supabase Configuration
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_KEY: ${SUPABASE_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}

      # Frontend URL for password reset emails
      FRONTEND_URL: http://localhost:3000
    ports:
      - "8010:8010"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8010/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - finio-network
    restart: unless-stopped

  # Watchlist Service (User Watchlist Management)
  watchlist-service:
    build:
      context: ./services/watchlist-service
      dockerfile: Dockerfile
    container_name: finio-watchlist-service
    environment:
      SERVICE_NAME: watchlist-service
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: 8012
      LOG_LEVEL: DEBUG
      DEBUG: "true"
      DATABASE_URL: ${DATABASE_URL}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-super-secret-key-change-in-production-min-32-chars}
      JWT_ALGORITHM: HS256
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}
      FREE_TIER_WATCHLIST_LIMIT: 3
      PAID_TIER_WATCHLIST_LIMIT: 999
      CORS_ORIGINS: http://localhost:8080,http://localhost:3000
    ports:
      - "8012:8012"
    healthcheck:
      test: [ "CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8012/health', timeout=5.0)" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - finio-network
    restart: unless-stopped

  # Data Service (Data Ingestion & ETL)
  data-service:
    build:
      context: ./services/data-service
      dockerfile: Dockerfile
    container_name: finio-data-service
    environment:
      SERVICE_NAME: data-service
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: 8013
      LOG_LEVEL: INFO
      DEBUG: "true"
      DATABASE_URL: ${DATABASE_URL}
      MASSIVE_API_KEY: ${MASSIVE_API_KEY}
      MASSIVE_USE_REALTIME: ${MASSIVE_USE_REALTIME:-false}
      MASSIVE_S3_ACCESS_KEY_ID: ${MASSIVE_S3_ACCESS_KEY_ID}
      MASSIVE_S3_SECRET_ACCESS_KEY: ${MASSIVE_S3_SECRET_ACCESS_KEY}
      MASSIVE_S3_ENDPOINT: ${MASSIVE_S3_ENDPOINT}
      MASSIVE_S3_BUCKET: ${MASSIVE_S3_BUCKET}
      SUPABASE_S3_STORAGE_URL: ${SUPABASE_S3_STORAGE_URL}
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_KEY: ${SUPABASE_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      PREFECT_API_URL: http://prefect-server:4200/api
      SEARCH_SERVICE_URL: http://search-service:8000
    ports:
      - "8013:8000"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - finio-network
    restart: unless-stopped

  # ML Service (Model Training & Inference)
  ml-service:
    build:
      context: ./services/ml-service
      dockerfile: Dockerfile
    container_name: finio-ml-service
    environment:
      SERVICE_NAME: ml-service
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: 8014
      LOG_LEVEL: INFO
      DEBUG: "true"
      DATABASE_URL: ${DATABASE_URL}
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_KEY: ${SUPABASE_KEY}
      SUPABASE_BUCKET_MODELS: "finio-models"
    ports:
      - "8014:8000"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - finio-network
    restart: unless-stopped

  # Search Service (Stock Search API)
  search-service:
    build:
      context: ./services/search-service
      dockerfile: Dockerfile.dev
    container_name: finio-search-service
    environment:
      # Database Configuration
      DATABASE_URL: ${DATABASE_URL}

      # Redis Configuration
      REDIS_URL: ${REDIS_URL}

      # JWT Configuration (must match auth-service)
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-super-secret-key-change-in-production-min-32-chars}

      # Auth Service URL (for user tier checking)
      AUTH_SERVICE_URL: http://auth-service:8010

      # CORS
      CORS_ORIGINS: http://localhost:8080,http://localhost:3000

      # External APIs
      YAHOO_FINANCE_TIMEOUT: 5.0
      YAHOO_FINANCE_MAX_RETRIES: 3
      YAHOO_FINANCE_RATE_LIMIT: 5

      # Massive API Configuration
      MASSIVE_API_KEY: ${MASSIVE_API_KEY}
      MASSIVE_USE_REALTIME: ${MASSIVE_USE_REALTIME:-false}

      # Cache Settings (PostgreSQL only - Redis removed)
      POSTGRES_CACHE_TTL_MINUTES: 5

      # Circuit Breaker
      CIRCUIT_BREAKER_FAILURE_THRESHOLD: 5
      CIRCUIT_BREAKER_RECOVERY_TIMEOUT: 60

      # Logging
      LOG_LEVEL: DEBUG
      LOG_FORMAT: text

      # Monitoring
      PROMETHEUS_ENABLED: true
      METRICS_PORT: 9090
    ports:
      - "8000:8000"
      - "9090:9090" # Prometheus metrics
    volumes:
      # Mount source code for hot-reload
      - ./services/search-service/app:/app/app:ro
      - ./services/search-service/alembic:/app/alembic:ro
      - ./services/search-service/alembic.ini:/app/alembic.ini:ro
    healthcheck:
      test: [ "CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health', timeout=5.0)" ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - finio-network
    restart: unless-stopped

  # Notification Service (Email Notifications & Price Alerts)
  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    container_name: finio-notification-service
    environment:
      SERVICE_NAME: notification-service
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: 8040
      LOG_LEVEL: INFO
      DEBUG: "true"
      DATABASE_URL: ${DATABASE_URL}
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: HS256
      RESEND_API_KEY: ${RESEND_API_KEY}
      RESEND_FROM_EMAIL: noreply@finio.cloud
      RESEND_FROM_NAME: Finio Stock Research
      SEARCH_SERVICE_URL: http://search-service:8000
      CORS_ORIGINS: http://localhost:8080,http://localhost:3000
      NOTIFICATION_CHECK_INTERVAL: 3600
      PRICE_ALERT_SEND_HOUR: 8
      ALERT_COOLDOWN_HOURS: 24
    ports:
      - "8040:8040"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8040/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - finio-network
    restart: unless-stopped

  # ==================== FRONTEND ====================

  # Webapp Service (Next.js Modern Frontend)
  webapp-service:
    build:
      context: ./services/webapp-service
      dockerfile: Dockerfile.dev
    container_name: finio-webapp-service
    environment:
      # API Service URLs (for client-side requests - browser makes direct requests)
      # NOTE: These must be accessible from the browser, not just from the container
      # Use localhost for local development, or your domain for production
      NEXT_PUBLIC_AUTH_SERVICE_URL: http://localhost:8010
      NEXT_PUBLIC_SEARCH_SERVICE_URL: http://localhost:8000
      NEXT_PUBLIC_WATCHLIST_SERVICE_URL: http://localhost:8012
      NEXT_PUBLIC_USER_SERVICE_URL: http://localhost:8011
      NEXT_PUBLIC_DATA_SERVICE_URL: http://localhost:8013
      NEXT_PUBLIC_ML_SERVICE_URL: http://localhost:8014
      NEXT_PUBLIC_NOTIFICATION_SERVICE_URL: http://localhost:8040

      # Next.js Configuration
      NODE_ENV: development
      PORT: 3000
      HOSTNAME: 0.0.0.0
      NEXT_TELEMETRY_DISABLED: 1
    ports:
      - "3000:3000"
    volumes:
      # Mount source for hot reload in development
      # Exclude node_modules and .next to avoid permission/build issues
      - ./services/webapp-service:/app:cached
      - webapp_node_modules:/app/node_modules
      - webapp_next:/app/.next
    depends_on:
      search-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
      watchlist-service:
        condition: service_healthy
      data-service:
        condition: service_healthy
      ml-service:
        condition: service_healthy
    networks:
      - finio-network
    restart: unless-stopped

networks:
  finio-network:
    driver: bridge

volumes:
  webapp_node_modules:
  webapp_next:
