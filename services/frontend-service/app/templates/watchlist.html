{% extends "base.html" %}

{% block title %}My Watchlist - {{ app_name }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto" x-data="watchlistPage()" x-init="loadWatchlist()">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-4xl font-bold text-primary mb-2">My Watchlist</h1>
            <p class="text-secondary">
                <span x-text="watchlist.length"></span> / 
                <span x-text="$store.auth.tier === 'paid' ? 'âˆž' : '3'"></span> stocks
            </p>
        </div>
        
        <!-- Upgrade button for free users -->
        <template x-if="$store.auth.tier === 'free'">
            <a href="/upgrade" class="bg-success text-white px-6 py-3 rounded-xl font-medium hover:bg-opacity-90 transition flex items-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                <span>Upgrade to Premium</span>
            </a>
        </template>
    </div>
    
    <!-- Add stock form -->
    <div class="modern-card p-6 mb-8">
        <h2 class="text-xl font-bold text-primary mb-4">Add Stock</h2>
        
        <form @submit.prevent="addStock()" class="flex gap-4">
            <input 
                type="text" 
                x-model="newSymbol"
                placeholder="Enter stock symbol (e.g., AAPL)"
                class="flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"
                :disabled="loading"
            >
            <button 
                type="submit"
                :disabled="loading || !newSymbol"
                class="bg-primary text-white px-8 py-3 rounded-xl font-medium hover:bg-opacity-90 transition disabled:opacity-50"
            >
                <span x-show="!loading">Add</span>
                <span x-show="loading">Adding...</span>
            </button>
        </form>
        
        <!-- Error message -->
        <div x-show="error" x-transition class="mt-4 bg-red-50 border border-red-200 rounded-xl p-4">
            <p class="text-sm text-red-600" x-text="error"></p>
        </div>
    </div>
    
    <!-- Watchlist items -->
    <div class="space-y-4">
        <template x-if="watchlist.length === 0 && !loading">
            <div class="modern-card p-12 text-center">
                <div class="w-20 h-20 mx-auto mb-6 bg-accent rounded-full flex items-center justify-center">
                    <svg class="w-10 h-10 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-primary mb-2">No stocks in watchlist</h3>
                <p class="text-secondary">Add stocks to start tracking predictions</p>
            </div>
        </template>
        
        <template x-for="item in watchlist" :key="item.id">
            <div class="modern-card p-6 hover:shadow-lg transition">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold text-primary mb-2" x-text="item.symbol"></h3>
                        <p class="text-sm text-secondary" x-text="'Added ' + new Date(item.added_at).toLocaleDateString()"></p>
                        
                        <template x-if="item.notes">
                            <p class="mt-3 text-secondary" x-text="item.notes"></p>
                        </template>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <a :href="'/predictions/' + item.symbol" class="text-primary hover:text-secondary transition">
                            View Predictions
                        </a>
                        <button 
                            @click="removeStock(item.symbol)"
                            class="text-danger hover:text-red-700 transition"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>

<script>
    function watchlistPage() {
        return {
            watchlist: [],
            newSymbol: '',
            loading: false,
            error: null,
            
            async loadWatchlist() {
                this.loading = true;
                
                try {
                    const response = await fetch('/api/watchlist', {
                        headers: {
                            'Authorization': Alpine.store('auth').getAuthHeader()
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to load watchlist');
                    
                    const data = await response.json();
                    this.watchlist = data.watchlist || [];
                    
                } catch (err) {
                    this.error = err.message;
                } finally {
                    this.loading = false;
                }
            },
            
            async addStock() {
                if (!this.newSymbol) return;
                
                this.loading = true;
                this.error = null;
                
                try {
                    const response = await fetch('/api/watchlist', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': Alpine.store('auth').getAuthHeader()
                        },
                        body: JSON.stringify({
                            symbol: this.newSymbol.toUpperCase()
                        })
                    });
                    
                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.detail || 'Failed to add stock');
                    }
                    
                    this.newSymbol = '';
                    await this.loadWatchlist();
                    
                } catch (err) {
                    this.error = err.message;
                } finally {
                    this.loading = false;
                }
            },
            
            async removeStock(symbol) {
                if (!confirm(`Remove ${symbol} from watchlist?`)) return;
                
                try {
                    const response = await fetch(`/api/watchlist/${symbol}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': Alpine.store('auth').getAuthHeader()
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to remove stock');
                    
                    await this.loadWatchlist();
                    
                } catch (err) {
                    this.error = err.message;
                }
            }
        }
    }
</script>
{% endblock %}

