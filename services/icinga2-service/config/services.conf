/*
 * Service definitions for QNT9 infrastructure monitoring
 * Comprehensive monitoring for microservices, APIs, containers, and infrastructure
 */

// ==================== BASIC HEALTH CHECKS ====================

// HTTP Health Check for Services with Health Endpoints
apply Service "http_health" {
  import "generic-service"
  check_command = "http"
  vars.http_vhost = host.address
  vars.http_port = host.vars.http_port
  vars.http_uri = host.vars.http_uri
  vars.http_expect = "healthy"
  check_interval = 30s
  retry_interval = 15s
  
  assign where host.vars.http_port && host.vars.http_uri
}

// TCP Port Check for Databases and Message Brokers
apply Service "tcp_port" {
  import "generic-service"
  check_command = "tcp"
  vars.tcp_port = host.vars.tcp_port
  check_interval = 60s
  retry_interval = 30s
  
  assign where host.vars.tcp_port && !host.vars.http_port
}

// Ping Check for All Hosts
apply Service "ping4" {
  import "generic-service"
  check_command = "ping4"
  check_interval = 60s
  retry_interval = 30s
  
  assign where host.address
}

// ==================== DATABASE MONITORING ====================

// PostgreSQL Database Check with Connection Time
apply Service "pgsql_connection" {
  import "generic-service"
  check_command = "pgsql"
  vars.pgsql_hostname = host.address
  vars.pgsql_port = host.vars.pgsql_port
  vars.pgsql_database = "postgres"
  check_interval = 60s
  retry_interval = 30s
  
  assign where host.vars.pgsql_port
}

// PostgreSQL Performance Check
apply Service "pgsql_performance" {
  import "generic-service"
  check_command = "check_db_pool"
  vars.pgsql_database = host.vars.pgsql_database
  vars.pgsql_user = "postgres"
  vars.pgsql_warn_time = 2
  vars.pgsql_critical_time = 5
  check_interval = 120s
  retry_interval = 60s
  
  assign where host.vars.pgsql_port
}

// Redis Connection and Response Check
apply Service "redis_health" {
  import "generic-service"
  check_command = "check_redis_info"
  check_interval = 60s
  retry_interval = 30s
  
  assign where host.vars.redis_port
}

// ==================== API RESPONSE TIME MONITORING ====================

// Search Service - Detailed API Monitoring
apply Service "search_api_response_time" {
  import "generic-service"
  check_command = "check_api_json"
  vars.api_port = 8000
  vars.api_uri = "/api/v1/health"
  vars.api_expect_string = "healthy"
  vars.api_warn_time = 1500
  vars.api_critical_time = 3000
  check_interval = 30s
  retry_interval = 15s
  
  assign where host.name == "search-service"
}

// Feature Engineering Service - API Response Time
apply Service "feature_engineering_api_response_time" {
  import "generic-service"
  check_command = "check_api_json"
  vars.api_port = 8003
  vars.api_uri = "/health"
  vars.api_expect_string = "healthy"
  vars.api_warn_time = 2000
  vars.api_critical_time = 5000
  check_interval = 30s
  retry_interval = 15s
  
  assign where host.name == "feature-engineering-service"
}

// Feature Engineering Service - Redis Connection
apply Service "feature_engineering_redis_connection" {
  import "generic-service"
  check_command = "check_redis_connection"
  vars.service_name = "feature-engineering-service"
  check_interval = 60s
  retry_interval = 30s
  
  assign where host.name == "feature-engineering-service"
}

// Feature Engineering Service - Kafka Consumer
apply Service "feature_engineering_kafka_consumer" {
  import "generic-service"
  check_command = "check_kafka_consumer"
  vars.service_name = "feature-engineering-service"
  vars.consumer_group = "feature-engineering-group"
  check_interval = 120s
  retry_interval = 60s
  
  assign where host.name == "feature-engineering-service"
}

// Feature Engineering Service - Feature Store Size
apply Service "feature_engineering_feature_store" {
  import "generic-service"
  check_command = "check_feature_store_size"
  vars.warn_size = 1000
  vars.critical_size = 10000
  check_interval = 300s
  retry_interval = 120s
  
  assign where host.name == "feature-engineering-service"
}

// Feature Engineering Service - Metrics Endpoint
apply Service "feature_engineering_metrics" {
  import "generic-service"
  check_command = "http"
  vars.http_vhost = host.address
  vars.http_port = 8003
  vars.http_uri = "/metrics"
  check_interval = 60s
  retry_interval = 30s
  
  assign where host.name == "feature-engineering-service"
}

// Search Service - Metrics Endpoint
apply Service "search_metrics" {
  import "generic-service"
  check_command = "check_prometheus_metrics"
  vars.metrics_port = 9090
  vars.metrics_uri = "/metrics"
  check_interval = 60s
  retry_interval = 30s
  
  assign where host.name == "search-service"
}

// Data Ingestion Service - API Health
apply Service "ingestion_api_response_time" {
  import "generic-service"
  check_command = "check_api_json"
  vars.api_port = 8001
  vars.api_uri = "/health"
  vars.api_expect_string = "healthy"
  vars.api_warn_time = 2000
  vars.api_critical_time = 5000
  check_interval = 30s
  retry_interval = 15s
  
  assign where host.name == "data-ingestion-service"
}

// Data Ingestion Service - Provider Status
apply Service "ingestion_providers" {
  import "generic-service"
  check_command = "check_api_json"
  vars.api_port = 8001
  vars.api_uri = "/health"
  vars.api_expect_string = "yahoo"
  check_interval = 120s
  retry_interval = 60s
  
  assign where host.name == "data-ingestion-service"
}

// ETL Pipeline Service - Processing Health
apply Service "etl_api_response_time" {
  import "generic-service"
  check_command = "check_api_json"
  vars.api_port = 8002
  vars.api_uri = "/health"
  vars.api_expect_string = "healthy"
  vars.api_warn_time = 2000
  vars.api_critical_time = 5000
  check_interval = 30s
  retry_interval = 15s
  
  assign where host.name == "etl-pipeline-service"
}

// ETL Pipeline Service - Metrics and Queue Depth
apply Service "etl_metrics" {
  import "generic-service"
  check_command = "check_prometheus_metrics"
  vars.metrics_port = 9102
  vars.metrics_uri = "/metrics"
  check_interval = 60s
  retry_interval = 30s
  
  assign where host.name == "etl-pipeline-service"
}

// ETL Pipeline Service - Kafka Consumer Health
apply Service "etl_kafka_consumer" {
  import "generic-service"
  check_command = "check_etl_queue"
  check_interval = 120s
  retry_interval = 60s
  
  assign where host.name == "etl-pipeline-service"
}

// Frontend Service - User-Facing Health
apply Service "frontend_api_response_time" {
  import "generic-service"
  check_command = "check_api_json"
  vars.api_port = 8080
  vars.api_uri = "/health"
  vars.api_expect_string = "healthy"
  vars.api_warn_time = 1000
  vars.api_critical_time = 3000
  check_interval = 30s
  retry_interval = 15s
  
  assign where host.name == "frontend-service"
}

// Frontend Service - Search Service Dependency
apply Service "frontend_dependency_check" {
  import "generic-service"
  check_command = "check_api_json"
  vars.api_port = 8080
  vars.api_uri = "/health"
  vars.api_expect_string = "search_service"
  check_interval = 60s
  retry_interval = 30s
  
  assign where host.name == "frontend-service"
}

// ==================== CONSUL SERVICE DISCOVERY ====================

// Consul API Health
apply Service "consul_api" {
  import "generic-service"
  check_command = "http"
  vars.http_vhost = host.address
  vars.http_port = 8500
  vars.http_uri = "/v1/status/leader"
  check_interval = 60s
  retry_interval = 30s
  
  assign where host.name == "consul"
}

// Consul Service Registration Count
apply Service "consul_services" {
  import "generic-service"
  check_command = "check_consul_service"
  vars.consul_service_name = "search-service"
  check_interval = 120s
  retry_interval = 60s
  
  assign where host.name == "consul"
}

// ==================== KAFKA MONITORING ====================

// Kafka Broker Health
apply Service "kafka_broker" {
  import "generic-service"
  check_command = "check_kafka_health"
  check_interval = 60s
  retry_interval = 30s
  
  assign where host.name == "kafka"
}

// ==================== SERVICE-SPECIFIC METRICS ====================

// Search Service - Cache Hit Rate (via health endpoint)
apply Service "search_cache_performance" {
  import "generic-service"
  check_command = "check_service_memory"
  vars.service_port = 8000
  vars.service_health_uri = "/api/v1/health"
  check_interval = 120s
  retry_interval = 60s
  
  assign where host.name == "search-service"
}

// Data Ingestion - Storage Status
apply Service "ingestion_storage" {
  import "generic-service"
  check_command = "check_api_json"
  vars.api_port = 8001
  vars.api_uri = "/health"
  vars.api_expect_string = "database"
  check_interval = 120s
  retry_interval = 60s
  
  assign where host.name == "data-ingestion-service"
}

// ETL Pipeline - Database Connectivity
apply Service "etl_database" {
  import "generic-service"
  check_command = "check_api_json"
  vars.api_port = 8002
  vars.api_uri = "/health"
  vars.api_expect_string = "database"
  check_interval = 120s
  retry_interval = 60s
  
  assign where host.name == "etl-pipeline-service"
}

// ETL Pipeline - Idempotency Check
apply Service "etl_idempotency" {
  import "generic-service"
  check_command = "check_api_json"
  vars.api_port = 8002
  vars.api_uri = "/health"
  vars.api_expect_string = "idempotency"
  check_interval = 300s
  retry_interval = 120s
  
  assign where host.name == "etl-pipeline-service"
}

// ==================== LEGACY CHECKS (Keep for compatibility) ====================

// Search Service Response Time
apply Service "search_service_response_time" {
  import "generic-service"
  check_command = "http"
  vars.http_vhost = host.address
  vars.http_port = 8000
  vars.http_uri = "/api/v1/health"
  vars.http_warn_time = 2000
  vars.http_critical_time = 5000
  check_interval = 60s
  
  assign where host.name == "search-service"
}

// Data Ingestion Service Response Time
apply Service "ingestion_service_response_time" {
  import "generic-service"
  check_command = "http"
  vars.http_vhost = host.address
  vars.http_port = 8001
  vars.http_uri = "/health"
  vars.http_warn_time = 2000
  vars.http_critical_time = 5000
  check_interval = 60s
  
  assign where host.name == "data-ingestion-service"
}

// ETL Pipeline Service Response Time
apply Service "etl_service_response_time" {
  import "generic-service"
  check_command = "http"
  vars.http_vhost = host.address
  vars.http_port = 8002
  vars.http_uri = "/health"
  vars.http_warn_time = 2000
  vars.http_critical_time = 5000
  check_interval = 60s
  
  assign where host.name == "etl-pipeline-service"
}

// Frontend Service Response Time
apply Service "frontend_service_response_time" {
  import "generic-service"
  check_command = "http"
  vars.http_vhost = host.address
  vars.http_port = 8080
  vars.http_uri = "/health"
  vars.http_warn_time = 1000
  vars.http_critical_time = 3000
  check_interval = 60s
  
  assign where host.name == "frontend-service"
}
