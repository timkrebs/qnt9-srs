/*
 * Custom check commands for QNT9 SRS monitoring
 */

// Check Docker container stats (CPU, Memory, Network)
object CheckCommand "check_docker_stats" {
  command = [ PluginDir + "/check_http" ]

  arguments = {
    "-H" = {
      value = "$docker_stats_host$"
      description = "Docker host"
    }
    "-p" = {
      value = "$docker_stats_port$"
      description = "Docker API port"
    }
    "-u" = {
      value = "/containers/$docker_container_id$/stats?stream=false"
      description = "Stats endpoint"
    }
    "-t" = {
      value = 10
      description = "Timeout"
    }
  }

  vars.docker_stats_host = "$host.address$"
  vars.docker_stats_port = 2375
}

// Check API endpoint with JSON response validation
object CheckCommand "check_api_json" {
  command = [ PluginDir + "/check_http" ]

  arguments = {
    "-H" = {
      value = "$api_host$"
      description = "API host"
    }
    "-p" = {
      value = "$api_port$"
      description = "API port"
    }
    "-u" = {
      value = "$api_uri$"
      description = "API endpoint URI"
    }
    "-s" = {
      value = "$api_expect_string$"
      description = "Expected string in response"
    }
    "--header" = {
      value = "Content-Type: application/json"
      description = "JSON header"
    }
    "-t" = {
      value = "$api_timeout$"
      description = "Request timeout"
    }
    "-w" = {
      value = "$api_warn_time$"
      description = "Warning response time (ms)"
    }
    "-c" = {
      value = "$api_critical_time$"
      description = "Critical response time (ms)"
    }
  }

  vars.api_host = "$host.address$"
  vars.api_timeout = 10
  vars.api_warn_time = 2000
  vars.api_critical_time = 5000
}

// Check Prometheus metrics endpoint
object CheckCommand "check_prometheus_metrics" {
  command = [ PluginDir + "/check_http" ]

  arguments = {
    "-H" = {
      value = "$metrics_host$"
      description = "Metrics host"
    }
    "-p" = {
      value = "$metrics_port$"
      description = "Metrics port"
    }
    "-u" = {
      value = "$metrics_uri$"
      description = "Metrics endpoint"
    }
    "-s" = {
      value = "# HELP"
      description = "Expect Prometheus format"
    }
    "-t" = {
      value = 5
      description = "Timeout"
    }
  }

  vars.metrics_host = "$host.address$"
  vars.metrics_uri = "/metrics"
}

// Check Kafka topic lag
object CheckCommand "check_kafka_health" {
  command = [ PluginDir + "/check_tcp" ]

  arguments = {
    "-H" = {
      value = "$kafka_host$"
      description = "Kafka host"
    }
    "-p" = {
      value = "$kafka_port$"
      description = "Kafka port"
    }
    "-t" = {
      value = 10
      description = "Connection timeout"
    }
  }

  vars.kafka_host = "$host.address$"
  vars.kafka_port = 9092
}

// Check Redis connection and info
object CheckCommand "check_redis_info" {
  command = [ PluginDir + "/check_tcp" ]

  arguments = {
    "-H" = {
      value = "$redis_host$"
      description = "Redis host"
    }
    "-p" = {
      value = "$redis_port$"
      description = "Redis port"
    }
    "-E" = {
      set_if = "$redis_check_response$"
      description = "Check response"
    }
    "-s" = {
      value = "$redis_send$"
      description = "String to send"
    }
    "-e" = {
      value = "$redis_expect$"
      description = "Expected response"
    }
    "-t" = {
      value = 5
      description = "Timeout"
    }
  }

  vars.redis_host = "$host.address$"
  vars.redis_port = 6379
  vars.redis_check_response = true
  vars.redis_send = "PING\\r\\n"
  vars.redis_expect = "+PONG"
}

// Check database connection pool status
object CheckCommand "check_db_pool" {
  command = [ PluginDir + "/check_pgsql" ]

  arguments = {
    "-H" = {
      value = "$pgsql_host$"
      description = "PostgreSQL host"
    }
    "-p" = {
      value = "$pgsql_port$"
      description = "PostgreSQL port"
    }
    "-d" = {
      value = "$pgsql_database$"
      description = "Database name"
    }
    "-l" = {
      value = "$pgsql_user$"
      description = "Username"
    }
    "-t" = {
      value = 10
      description = "Timeout"
    }
    "-w" = {
      value = "$pgsql_warn_time$"
      description = "Warning response time"
    }
    "-c" = {
      value = "$pgsql_critical_time$"
      description = "Critical response time"
    }
  }

  vars.pgsql_host = "$host.address$"
  vars.pgsql_port = 5432
  vars.pgsql_warn_time = 2
  vars.pgsql_critical_time = 5
}

// Check ETL job queue depth
object CheckCommand "check_etl_queue" {
  command = [ PluginDir + "/check_http" ]

  arguments = {
    "-H" = {
      value = "$etl_host$"
      description = "ETL service host"
    }
    "-p" = {
      value = "$etl_port$"
      description = "ETL service port"
    }
    "-u" = {
      value = "/metrics"
      description = "Metrics endpoint"
    }
    "-s" = {
      value = "kafka_consumer_lag"
      description = "Look for consumer lag metric"
    }
    "-t" = {
      value = 10
      description = "Timeout"
    }
  }

  vars.etl_host = "$host.address$"
  vars.etl_port = 8002
}

// Check service memory usage via health endpoint
object CheckCommand "check_service_memory" {
  command = [ PluginDir + "/check_http" ]

  arguments = {
    "-H" = {
      value = "$service_host$"
      description = "Service host"
    }
    "-p" = {
      value = "$service_port$"
      description = "Service port"
    }
    "-u" = {
      value = "$service_health_uri$"
      description = "Health endpoint"
    }
    "-s" = {
      value = "healthy"
      description = "Expected healthy status"
    }
    "-t" = {
      value = 10
      description = "Timeout"
    }
  }

  vars.service_host = "$host.address$"
  vars.service_health_uri = "/health"
}

// Check Consul service health
object CheckCommand "check_consul_service" {
  command = [ PluginDir + "/check_http" ]

  arguments = {
    "-H" = {
      value = "$consul_host$"
      description = "Consul host"
    }
    "-p" = {
      value = "$consul_port$"
      description = "Consul port"
    }
    "-u" = {
      value = "/v1/health/service/$consul_service_name$?passing=true"
      description = "Service health endpoint"
    }
    "-s" = {
      value = "passing"
      description = "Expect passing status"
    }
    "-t" = {
      value = 5
      description = "Timeout"
    }
  }

  vars.consul_host = "$host.address$"
  vars.consul_port = 8500
}

// Check API rate limiting
object CheckCommand "check_api_rate_limit" {
  command = [ PluginDir + "/check_http" ]

  arguments = {
    "-H" = {
      value = "$api_host$"
      description = "API host"
    }
    "-p" = {
      value = "$api_port$"
      description = "API port"
    }
    "-u" = {
      value = "$api_uri$"
      description = "API endpoint"
    }
    "--header" = {
      value = "X-Check-Type: rate-limit"
      description = "Rate limit check header"
    }
    "-t" = {
      value = 5
      description = "Timeout"
    }
  }

  vars.api_host = "$host.address$"
}
